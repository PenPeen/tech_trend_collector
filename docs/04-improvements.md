# 実行計画書 04: 改善・エラーハンドリング強化

## 概要

| 項目 | 内容 |
|------|------|
| フェーズ | Phase 4: 改善・調整 |
| 目的 | エラーハンドリング強化、ロギング改善、安定性向上 |
| 前提条件 | Phase 3（PR #03）がマージ済みであること |

---

## スコープ

### 含まれるもの
- エラーハンドリング強化
- ロギング機能追加
- リトライ機構
- タイムアウト設定
- 設定のバリデーション

### 含まれないもの
- 新規ソース追加（スコープ外）
- 週次/月次レポート（スコープ外）

---

## 実装タスク

### 1. ロギング機能追加

- [ ] `src/utils/logger.py` 作成
  - Python標準logging設定
  - ログレベル: INFO（通常時）、DEBUG（開発時）
  - ログフォーマット: `[YYYY-MM-DD HH:MM:SS] [LEVEL] message`
  - GitHub Actions出力対応

- [ ] 各モジュールにロギング追加
  - `collectors/qiita.py`: 取得開始/完了/エラー
  - `collectors/zenn.py`: 取得開始/完了/エラー
  - `services/summarizer.py`: 要約開始/完了/エラー
  - `services/notifier.py`: 通知送信/成功/失敗
  - `main.py`: 全体フロー

### 2. エラーハンドリング強化

- [ ] `src/collectors/qiita.py` 更新
  - RSS取得タイムアウト設定（30秒）
  - ネットワークエラーのキャッチ
  - パースエラーのキャッチ
  - 失敗時は空リスト返却 + ログ出力

- [ ] `src/collectors/zenn.py` 更新
  - 同上

- [ ] `src/services/summarizer.py` 更新
  - API呼び出しタイムアウト設定（60秒）
  - レート制限エラーのハンドリング
  - リトライ機構（最大3回、指数バックオフ）
  - 失敗時は空文字列返却 + ログ出力

- [ ] `src/services/notifier.py` 更新
  - API呼び出しタイムアウト設定（30秒）
  - 失敗時もプログラム全体は継続

- [ ] `src/services/deduplicator.py` 更新
  - history.jsonが壊れている場合の復旧処理
  - ファイルロック考慮（同時実行防止）

### 3. リトライ機構

- [ ] `src/utils/retry.py` 作成
  - `@retry(max_attempts=3, backoff_factor=2)` デコレータ
  - 指数バックオフ（1秒 → 2秒 → 4秒）
  - リトライ対象例外の指定

- [ ] 要約サービスにリトライ適用
  - Gemini API呼び出しにリトライデコレータ適用

### 4. 設定バリデーション

- [ ] `src/utils/config.py` 更新
  - `validate_config()` 関数追加
  - 必須環境変数のチェック
  - APIキーのフォーマット簡易チェック
  - 起動時にバリデーション実行

### 5. 実行結果サマリー改善

- [ ] `src/main.py` 更新
  - 実行結果の詳細サマリー出力
    ```
    ========================================
    TechTrendCollector 実行結果
    ========================================
    実行日時: 2025-01-19 17:00:00

    [記事取得]
    - Qiita: 5件取得 (新規: 3件, 重複: 2件)
    - Zenn:  5件取得 (新規: 4件, 重複: 1件)

    [要約生成]
    - 成功: 7件
    - 失敗: 0件

    [マークダウン生成]
    - 生成ファイル数: 7件
    - 出力先: articles/2025-01-19/

    [通知]
    - メール送信: 成功
    ========================================
    ```

### 6. GitHub Actions改善

- [ ] `.github/workflows/daily-collect.yml` 更新
  - ジョブのタイムアウト設定（30分）
  - 失敗時のSlack通知（オプション、将来対応）
  - Actionsサマリーへの結果出力

---

## 作成/変更ファイル一覧

| パス | 操作 | 説明 |
|------|------|------|
| `src/utils/logger.py` | 新規 | ロギング設定 |
| `src/utils/retry.py` | 新規 | リトライデコレータ |
| `src/utils/config.py` | 更新 | バリデーション追加 |
| `src/collectors/qiita.py` | 更新 | エラーハンドリング強化 |
| `src/collectors/zenn.py` | 更新 | エラーハンドリング強化 |
| `src/services/summarizer.py` | 更新 | リトライ・エラー処理 |
| `src/services/notifier.py` | 更新 | エラーハンドリング強化 |
| `src/services/deduplicator.py` | 更新 | 堅牢性向上 |
| `src/main.py` | 更新 | サマリー改善・ロギング |
| `.github/workflows/daily-collect.yml` | 更新 | タイムアウト設定 |

---

## エラーハンドリングポリシー

| エラー種別 | 対応 |
|-----------|------|
| RSS取得失敗（Qiita） | 警告ログ出力、Zennのみで処理続行 |
| RSS取得失敗（Zenn） | 警告ログ出力、Qiitaのみで処理続行 |
| RSS取得失敗（両方） | エラー通知メール送信、終了コード1 |
| Gemini API失敗 | 警告ログ出力、要約なしでMD生成 |
| Resend API失敗 | 警告ログ出力、処理は正常終了 |
| history.json破損 | バックアップから復元 or 空で再作成 |

---

## 完了条件

1. 各種エラー状況でも適切にハンドリングされる
2. ログ出力が適切に行われる
3. リトライ機構が動作する
4. 実行結果サマリーが見やすく出力される
5. GitHub Actionsでタイムアウトが設定される

---

## PRテンプレート

```markdown
## 概要
TechTrendCollector Phase 4: 改善・エラーハンドリング強化

運用安定性を向上させるため、エラーハンドリングとロギングを強化しました。

## 変更内容
- ロギング機能追加（Python標準logging）
- エラーハンドリング強化（タイムアウト、例外キャッチ）
- リトライ機構（Gemini API用、指数バックオフ）
- 設定バリデーション
- 実行結果サマリー改善
- GitHub Actionsタイムアウト設定

## テスト方法
1. 正常系: `python src/main.py` で全機能動作確認
2. 異常系:
   - 無効なAPIキーで実行 → エラーハンドリング確認
   - ネットワーク切断で実行 → タイムアウト確認

## 関連Issue
なし
```

---

## 備考

- このフェーズ完了でMVPとしての運用開始が可能
- 今後の拡張（新規ソース追加等）の基盤となる
- 監視・アラート強化は運用しながら検討
